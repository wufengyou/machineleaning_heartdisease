æˆ‘ä¾†å¹«ä½ é‡æ–°çµ„ç¹”é€™å€‹å°ˆæ¡ˆï¼Œå‰µå»ºå®Œæ•´çš„è¨“ç·´å’Œé æ¸¬æµç¨‹ã€‚

é¦–å…ˆæ˜¯è¨“ç·´è…³æœ¬ï¼š

```python
import pandas as pd
import numpy as np
from sklearn.preprocessing import StandardScaler
from sklearn.feature_extraction import DictVectorizer
from sklearn.linear_model import LogisticRegression
from sklearn.tree import DecisionTreeClassifier
from sklearn.ensemble import RandomForestClassifier
from xgboost import XGBClassifier
from lightgbm import LGBMClassifier
from imblearn.over_sampling import SMOTE
import pickle
from tqdm import tqdm
import time

class ModelTrainer:
    def __init__(self):
        self.numerical_features = ['bmi', 'physicalhealth', 'mentalhealth', 'sleeptime']
        self.categorical_features = ['smoking', 'alcoholdrinking', 'stroke', 'diffwalking', 
                                   'sex', 'agecategory', 'race', 'diabetic', 
                                   'physicalactivity', 'genhealth', 'asthma', 
                                   'kidneydisease', 'skincancer']
        self.models = {
            'logistic': (LogisticRegression, {'random_state': 42, 'max_iter': 1000}),
            'decision_tree': (DecisionTreeClassifier, {'random_state': 42, 'max_depth': 10}),
            'random_forest': (RandomForestClassifier, {'random_state': 42, 'n_estimators': 100}),
            'xgboost': (XGBClassifier, {'random_state': 42, 'n_estimators': 100}),
            'lightgbm': (LGBMClassifier, {'random_state': 42, 'n_estimators': 100})
        }
        
    def prepare_data(self, df):
        """æº–å‚™æ•¸æ“šï¼šæ¨™æº–åŒ–æ•¸å€¼ç‰¹å¾µå’Œç·¨ç¢¼é¡åˆ¥ç‰¹å¾µ"""
        # æ•¸å€¼ç‰¹å¾µè™•ç†
        scaler = StandardScaler()
        X_num = scaler.fit_transform(df[self.numerical_features])
        
        # é¡åˆ¥ç‰¹å¾µè™•ç†
        cat_data = df[self.categorical_features].copy()
        for col in self.categorical_features:
            cat_data[col] = cat_data[col].str.lower().str.replace(' ', '_')
        
        dv = DictVectorizer(sparse=False)
        X_cat = dv.fit_transform(cat_data.to_dict(orient='records'))
        
        # åˆä½µç‰¹å¾µ
        X = np.hstack([X_num, X_cat])
        
        return X, scaler, dv
    
    def train_model(self, X, y, model_class, model_params, use_smote=False):
        """è¨“ç·´å–®å€‹æ¨¡å‹"""
        if use_smote:
            smote = SMOTE(random_state=42)
            X, y = smote.fit_resample(X, y)
        
        model = model_class(**model_params)
        model.fit(X, y)
        return model
    
    def train_all_models(self, df_train, y_train, df_test):
        """è¨“ç·´æ‰€æœ‰æ¨¡å‹ä¸¦ä¿å­˜"""
        # æº–å‚™æ•¸æ“š
        X, scaler, dv = self.prepare_data(df_train)
        
        # ä¿å­˜æ¸¬è©¦é›†
        df_test.to_pickle('data/df_test.pkl')
        print("Saved test data")
        
        # ä½¿ç”¨tqdmå‰µå»ºé€²åº¦æ¢
        with tqdm(total=len(self.models) * 2) as pbar:
            for model_name, (model_class, params) in self.models.items():
                # è¨“ç·´åŸå§‹æ¨¡å‹
                model = self.train_model(X, y_train, model_class, params, use_smote=False)
                self.save_model(model, scaler, dv, f'models/{model_name}_original.bin')
                pbar.update(1)
                
                # è¨“ç·´SMOTEæ¨¡å‹
                model_smote = self.train_model(X, y_train, model_class, params, use_smote=True)
                self.save_model(model_smote, scaler, dv, f'models/{model_name}_smote.bin')
                pbar.update(1)
                
                time.sleep(0.1)  # è®“é€²åº¦æ¢æ›´å®¹æ˜“çœ‹è¦‹
    
    def save_model(self, model, scaler, dv, filename):
        """ä¿å­˜æ¨¡å‹å’Œé è™•ç†å™¨"""
        with open(filename, 'wb') as f_out:
            pickle.dump((dv, scaler, model), f_out)
        print(f"Saved model: {filename}")

def main():
    # è¼‰å…¥æ•¸æ“š
    df = pd.read_csv('heart_2020_cleaned.csv')
    
    # è³‡æ–™é è™•ç†
    df.columns = df.columns.str.lower()
    for col in df.select_dtypes(['object']).columns:
        df[col] = df[col].str.lower().str.replace(' ', '_')
    
    # å°‡ç›®æ¨™è®Šæ•¸è½‰æ›ç‚ºæ•¸å€¼
    df['heartdisease'] = (df['heartdisease'] == 'yes').astype(int)
    
    # åˆ†å‰²è¨“ç·´é›†å’Œæ¸¬è©¦é›†
    from sklearn.model_selection import train_test_split
    df_train, df_test = train_test_split(df, test_size=0.2, random_state=42)
    
    # æº–å‚™ç›®æ¨™è®Šæ•¸
    y_train = df_train.pop('heartdisease').values
    df_test_for_save = df_test.copy()
    y_test = df_test.pop('heartdisease').values
    
    # å‰µå»ºå¿…è¦çš„ç›®éŒ„
    import os
    os.makedirs('models', exist_ok=True)
    os.makedirs('data', exist_ok=True)
    
    # è¨“ç·´æ¨¡å‹
    trainer = ModelTrainer()
    trainer.train_all_models(df_train, y_train, df_test_for_save)

if __name__ == "__main__":
    main()

```

ç„¶å¾Œæ˜¯ Streamlit æ‡‰ç”¨ï¼š

```python
import streamlit as st
import pandas as pd
import numpy as np
import pickle
from pathlib import Path
import os

class HeartDiseasePredictor:
    def __init__(self):
        self.load_data()
        self.setup_page()
    
    def load_data(self):
        """è¼‰å…¥æ¸¬è©¦æ•¸æ“šå’Œç²å–å¯ç”¨çš„æ¨¡å‹"""
        self.df_test = pd.read_pickle('data/df_test.pkl')
        self.models_path = Path('models')
        self.available_models = list(self.models_path.glob('*.bin'))
    
    def setup_page(self):
        """è¨­ç½®é é¢ä½ˆå±€"""
        st.title('Heart Disease Prediction App')
        st.sidebar.title('Model Selection')
        
        # æ¨¡å‹é¸æ“‡
        self.selected_model_path = st.sidebar.selectbox(
            'Choose a model:',
            options=self.available_models,
            format_func=lambda x: x.stem  # åªé¡¯ç¤ºæ–‡ä»¶åï¼Œä¸é¡¯ç¤º.bin
        )
        
        # é¡¯ç¤ºæ¨¡å‹æè¿°
        model_type = self.selected_model_path.stem.split('_')[0]
        is_smote = 'smote' in self.selected_model_path.stem
        
        st.sidebar.markdown(f"""
        **Selected Model Info:**
        - Type: {model_type.upper()}
        - SMOTE: {'Yes' if is_smote else 'No'}
        """)
    
    def load_model(self, model_path):
        """è¼‰å…¥é¸æ“‡çš„æ¨¡å‹"""
        with open(model_path, 'rb') as f:
            return pickle.load(f)
    
    def create_feature_input(self):
        """å‰µå»ºç‰¹å¾µè¼¸å…¥ç•Œé¢"""
        st.header('Patient Information')
        
        # é¸æ“‡æ¸¬è©¦é›†æ¨£æœ¬
        test_index = st.number_input(
            'Select test set index:',
            min_value=0,
            max_value=len(self.df_test)-1,
            value=0
        )
        
        selected_patient = self.df_test.iloc[test_index].to_dict()
        
        col1, col2 = st.columns(2)
        
        # æ•¸å€¼ç‰¹å¾µ
        numerical_features = ['bmi', 'physicalhealth', 'mentalhealth', 'sleeptime']
        with col1:
            st.subheader('Numerical Features')
            numerical_values = {}
            for feature in numerical_features:
                numerical_values[feature] = st.number_input(
                    f'{feature}:',
                    value=float(selected_patient[feature]),
                    format='%f'
                )
        
        # é¡åˆ¥ç‰¹å¾µå’Œé¸é …
        categorical_features = {
            'smoking': ['yes', 'no'],
            'alcoholdrinking': ['yes', 'no'],
            'stroke': ['yes', 'no'],
            'diffwalking': ['yes', 'no'],
            'sex': ['female', 'male'],
            'agecategory': ['18-24', '25-29', '30-34', '35-39', '40-44', '45-49', 
                           '50-54', '55-59', '60-64', '65-69', '70-74', '75-79', '80_or_older'],
            'race': ['white', 'black', 'asian', 'hispanic', 'american_indian/alaskan_native', 'other'],
            'diabetic': ['yes', 'no', 'no,_borderline_diabetes', 'yes_(during_pregnancy)'],
            'physicalactivity': ['yes', 'no'],
            'genhealth': ['excellent', 'very_good', 'good', 'fair', 'poor'],
            'asthma': ['yes', 'no'],
            'kidneydisease': ['yes', 'no'],
            'skincancer': ['yes', 'no']
        }
        
        with col2:
            st.subheader('Categorical Features')
            categorical_values = {}
            for feature, options in categorical_features.items():
                current_value = str(selected_patient[feature]).lower()
                categorical_values[feature] = st.selectbox(
                    f'{feature}:',
                    options=options,
                    index=options.index(current_value) if current_value in options else 0
                )
        
        return {**numerical_values, **categorical_values}
    
    def predict(self, patient_data, dv, scaler, model):
        """é€²è¡Œé æ¸¬"""
        try:
            # å°‡æ•¸æ“šè½‰æ›ç‚ºDataFrame
            patient_df = pd.DataFrame([patient_data])
            
            # è™•ç†æ•¸å€¼ç‰¹å¾µ
            numerical_features = ['bmi', 'physicalhealth', 'mentalhealth', 'sleeptime']
            X_num = scaler.transform(patient_df[numerical_features])
            
            # è™•ç†é¡åˆ¥ç‰¹å¾µ
            categorical_dict = {k: v for k, v in patient_data.items() 
                              if k not in numerical_features}
            X_cat = dv.transform([categorical_dict])
            
            # åˆä½µç‰¹å¾µ
            X = np.hstack([X_num, X_cat])
            
            # é æ¸¬
            if hasattr(model, 'predict_proba'):
                return model.predict_proba(X)[0, 1]
            else:
                return model.predict(X)[0]
        except Exception as e:
            st.error(f"Prediction error: {str(e)}")
            return None
    
    def run(self):
        """é‹è¡Œæ‡‰ç”¨"""
        # è¼‰å…¥é¸æ“‡çš„æ¨¡å‹
        dv, scaler, model = self.load_model(self.selected_model_path)
        
        # å‰µå»ºç‰¹å¾µè¼¸å…¥ç•Œé¢
        patient_data = self.create_feature_input()
        
        # é æ¸¬æŒ‰éˆ•
        if st.button('Predict Heart Disease Risk'):
            probability = self.predict(patient_data, dv, scaler, model)
            
            if probability is not None:
                st.header('Prediction Result')
                
                # é€²åº¦æ¢é¡¯ç¤ºé¢¨éšª
                st.progress(probability)
                
                # é¡¯ç¤ºå…·é«”æ•¸å€¼
                st.metric(
                    label="Heart Disease Risk",
                    value=f"{probability:.1%}"
                )
                
                # é¢¨éšªç­‰ç´š
                risk_level = (
                    "ğŸ”´ High Risk! Please consult a doctor." if probability >= 0.7
                    else "ğŸŸ¡ Medium Risk. Regular check-ups recommended." if probability >= 0.3
                    else "ğŸŸ¢ Low Risk. Maintain a healthy lifestyle."
                )
                
                st.info(risk_level)
                
                # é¡¯ç¤ºé—œéµé¢¨éšªå› ç´ 
                st.subheader('Key Risk Factors')
                col1, col2, col3 = st.columns(3)
                with col1:
                    st.metric("BMI", f"{patient_data['bmi']:.1f}")
                with col2:
                    st.metric("Physical Health", f"{patient_data['physicalhealth']:.1f}")
                with col3:
                    st.metric("Mental Health", f"{patient_data['mentalhealth']:.1f}")

if __name__ == "__main__":
    app = HeartDiseasePredictor()
    app.run()

```

ä½¿ç”¨æ­¥é©Ÿï¼š

1. å®‰è£å¿…è¦çš„å¥—ä»¶ï¼š
```bash
pip install streamlit pandas numpy scikit-learn xgboost lightgbm imbalanced-learn tqdm
```

2. æ•´ç†å°ˆæ¡ˆçµæ§‹ï¼š
```
heart_disease_prediction/
â”œâ”€â”€ data/
â”œâ”€â”€ models/
â”œâ”€â”€ train.py
â”œâ”€â”€ app.py
â””â”€â”€ requirements.txt
```

3. è¨“ç·´æ¨¡å‹ï¼š
```bash
python train.py
```

4. é‹è¡Œ Streamlit æ‡‰ç”¨ï¼š
```bash
streamlit run app.py
```

é€™å€‹å¯¦ç¾çš„ç‰¹é»ï¼š

1. æ¨¡å‹è¨“ç·´ï¼š
   - æ”¯æ´å¤šç¨®æ¨¡å‹
   - SMOTE å’ŒåŸå§‹ç‰ˆæœ¬
   - è¨“ç·´é€²åº¦æ¢é¡¯ç¤º
   - è‡ªå‹•ä¿å­˜æ‰€æœ‰æ¨¡å‹

2. Streamlit ç•Œé¢ï¼š
   - æ¸…æ™°çš„æ¨¡å‹é¸æ“‡
   - ç›´è§€çš„æ•¸æ“šè¼¸å…¥
   - è©³ç´°çš„é æ¸¬çµæœ
   - é¢¨éšªç­‰ç´šè¦–è¦ºåŒ–

3. ä»£ç¢¼çµ„ç¹”ï¼š
   - æ¨¡å¡ŠåŒ–è¨­è¨ˆ
   - éŒ¯èª¤è™•ç†
   - æ¸…æ™°çš„ä»£ç¢¼è¨»é‡‹

4. ç”¨æˆ¶é«”é©—ï¼š
   - é€²åº¦æ¢é¡¯ç¤º
   - é¢¨éšªç­‰ç´šåˆ†é¡
   - é—œéµæŒ‡æ¨™å±•ç¤º
